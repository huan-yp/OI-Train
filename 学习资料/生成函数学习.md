**原文已经找不到了，这是 black_white_tony 大佬的翻译后的版本。**

**笔者对部分笔误进行了修正，并添加了一些笔记**

> 生成函数就像是上面挂着一个序列的所有元素的晾衣杆。这一个“晾衣杆”包含了序列的所有信息，可以把无限项的序列压缩成单独一个函数。是处理组合问题的利器。

## $\text{\S}$ 1. 普通生成函数

### $1.1$ 递推关系与普通生成函数

考察这样一个递推关系

$$
a_{n + 1} = 4a_n - 100 \tag{1}, a_0 = 40
$$

尽管递推关系是非常便于用计算机实现的，我们可以 $O(n)$ 地得到 $a$ 的前 $n$ 项每一项的值。然而如果问题是，我们只想知道第 $x$ 项的值，并且 $x$ 可以非常大，此时我们就不能通过逐项递推来得到答案。

这就引出了得到 $a_n$ 通项公式（explicit formula）的必要。

$\bold{Definition\ 1.}$ 令序列 $\{f_n\}_{n \geq 0}$ 为实数序列。则形式幂级数 $F(x) = \sum_{n \geq 0} f_nx^n$ 为该序列的 **普通生成函数**。且记 $f_n$ 为 $[x^n]G(x)$。

本节我们只讨论普通生成函数，因此下文中均以生成函数指代普通生成函数。

为了将 $(1)$ 式向 $\{a\}$ 的生成函数 $G(x)$ 靠拢，我们首先给两边都乘上 $x^{n + 1}$，并且求和，得到

$$
\sum_{n \geq 0} a_{n + 1}x^{x + 1} = \sum_{n \geq 0}4a_nx^{n + 1} - \sum_{n \geq 0}100x^{n + 1} \tag{2}
$$

等式左边为 $G(x) - a_0$，右边的第一项为 $4xG(x)$，第二项为 $\dfrac{100x}{1 - x}$（译注：$\sum 100x^{n + 1} = 100x\sum x^n$，由于我们认为形式幂级数的 $x$ 总是处于其收敛域中，因此 $\sum x^n = (1-x)^{-1}$）。则我们得到

$$
G(x) - a_0 = 4xG(x) - \frac{100x}{1 - x} \tag{3}
$$

至此，我们成功地将无限个等式变换为了和一个生成函数相关的式子。接下来的工作即求解这个生成函数，即得到这个生成函数的系数序列的信息。

将 $(3)$ 式整理得到

$$
G(x) = \dfrac{a_0}{1 - 4x} - \frac{100x}{(1 - x)(1 - 4x)} \tag{4}
$$

等式右边第一项，容易验证即 $a_0\sum_{n \geq 0}(4x)^n$ 的封闭形式。第二项则稍显复杂。我们期望将第二项表示为两个生成函数的和，这样能使我们方便地表示 $G(x)$ 每一项的系数。

采用待定系数法，令

$$
\frac{100x}{(1 - x)(1 - 4x)} = \frac{A}{1 - x} + \frac{B}{1 - 4x}
$$

求解可以得到 $A = \frac{100}3, B = -\frac{100}3$。因此 $(4)$ 式可以表达为

$$
G(x) = 40\frac 1 {1-4x} - \frac{100}{3}\frac 1 {1-x} + \frac{100}{3}\frac 1 {1-4x}
$$

我们知道 $(1-kx)^{-1}$ 正是 $\sum_{n \geq 0}(kx)^n$ 的封闭形式，因此有

$$
G(x) = 40\sum_{n \geq 0}4^nx^n +\frac{100}{3} \sum_{n \geq 0}(4^n - 1)x^n
$$

那么 $G(x)$ 的 $n$ 次项系数 $[x^n]G(x)$，即 $a_n = 40\cdot 4^n - 100 \cdot\frac{4^n - 1}{3}$。

总结一下，我们是如何通过生成函数来得到这个递推关系的通项公式的：

1. 定义 $G(x)$ 为 $\{a_n\}$ 的生成函数。
2. 通过在两边乘上 $x^{n + 1}$ 并求和，变化递推关系为关于 $G(x)$ 的方程。
3. 通过待定系数法求解 $G(x)$，即将 $G(x)$ 表示成几个简单的生成函数的和。
4. 观察 $G(x)$ 的 $n$ 次项系数得到答案。

$\bold{Example\ 1.}$ 求满足以下递推关系的 $a_n$ 的通项公式

$$
a_{n + 1} = 1.05a_n + 500, a_0 = 1000
$$

$\bold{Solution}.$

下文将以上述的四个步骤，一步一步展示过程。

1. 令 $G(x)$ 为 $\{a_n\}$ 的生成函数。

2. $$
   \sum_{n \geq 0}a_{n + 1}x^{n + 1} = 1.05\sum_{n \geq 0}a_nx^{n + 1} + \sum_{n \geq 0}500x^{n + 1}
   $$

   即

   $$
   G(x) - a_0 = 1.05xG(x) + \frac{500}{1 - x}
   $$

3. 即
   $$
    G(x) = \frac{1000}{1 - 1.05x} - \frac{500x}{(1 - x)(1 - 1.05x)}
   $$
   通过待定系数法可以得到

   $$
    G(x) = \frac{1000}{1 - 1.05x} + \frac {10000}{1 - 1.05x} - \frac{10000}{1 - x}
   $$

4. $[x^n]G(x) =a_n = 11000\cdot1.05^n - 10000$

接下来的例子将展示生成函数如何求项数更多的递推通项。

$\bold{Example\ 2.}$ 求满足以下递推关系的 $a_n$ 的通项

$$
a_{n + 2} = 3a_{n + 1} - 2a_{n}, a_0 = 0, a_1 = 1 \tag{5}
$$

$\bold{Solution.}$

令 $G(x)$ 为 $\{a_n\}$ 的生成函数。

不同于之前的例子，此时我们需要给 $(5)$ 的两边乘上 $x^{n + 2}$ 并求和。

$$
\sum_{n \geq 0}a_{n + 2}x^{n + 2} = 3\sum_{n \geq 0}a_{n + 1}x^{n +2} - 2\sum_{n \geq 0}a_nx^{n + 2}
$$

即

$$
G(x) - x = 3xG(x) - 2x^2G(x)
$$

得到

$$
G(x) = \frac x {1 - 3x + 2x^2}
$$

观察到 $1 - 3x + 2x^2 = (1-x)(1-2x)$，因此 $G(x)$ 的封闭形式一定可以表示为 $\dfrac{A}{1-x} + \dfrac{B}{1-2x}$。待定系数法求解得到

$$
G(x) = \frac 1 {1-2x} - \frac 1 {1 - x}
$$

展开得到

$$
G(x) = \sum_{n \geq 0} 2^n x^n - \sum_{n \geq 0}x^n
$$

因此 $[x^n]G(x) = a_n = 2^n - 1$。

$\bold{Example\ 3.}$ 求斐波那契数列 $a_{n + 2} = a_{n + 1} + a_n, a_0 = 1, a_1 = 2$ 的通项公式。

$\bold{Solution.}$

令 $G(x)$ 为 $\{a_n\}$ 的生成函数。有

$$
\sum_{n \geq 0}a_{n + 2}x^{n + 2} = \sum_{n \geq 0}a_{n + 1}x^{n + 2} + \sum_{n \geq 0}a_{n}x^{n + 2}
$$

即

$$
G(x) - 1 - 2x = xG(x) + x^2G(x)
$$

整理得到

$$
G(x) = \dfrac{1 + 2x}{1-x-x^2}
$$

令 $1-x-x^2$ 的两个根为 $\alpha, \beta$，因此 $G(x)$ 可以被表示为 $\dfrac A {x-\alpha} + \dfrac B {x - \beta}$。解方程得出 $A, B$。

此外，由于韦达定理，有 $\alpha\beta = 1$，则

$$
G(x) = -\dfrac{\beta A}{1 - x\beta} - \dfrac{\alpha B}{1 - x\alpha}
$$

即

$$
G(x) = -\beta A\sum_{n\geq 0}\beta^n - \alpha B\sum_{n \geq 0}\alpha^n
$$

因此 $[x^n]G(x) = a_n = -\beta^{n + 1}A - \alpha^{n + 1}B$。

*笔记：以下给出常见生成函数的封闭形式与展开形式的对照*
$$
\frac{1}{(x-1)^k}  =\sum_{0\le n}\tbinom{n+k-1}{k-1} x^n \\
$$


### 1.2 生成函数的乘法

$\bold{Lemma\ 1.}$ $F(x), G(x)$ 分别为 $\{f_n\}, \{g_n\}$ 的生成函数。$A(x)$ 为序列 $\{c_n \mid c_n = \sum_{i = 0}^n f_ig_{n - i}\}$ 则 $F(x)G(x) = A(x)$。

$\bold{Proof.}$ 

$$
\sum_{n\geq 0}f_nx^n\sum_{m\geq 0}g_mx^m = \sum_{n, m\geq 0}f_ng_mx^{n + m} = \sum_{n \geq 0}\sum_{i = 0}^n f_ig_{n - i}x^n = \sum_{n \geq 0} c_nx^n
$$

接下来我们考虑，将两个生成函数相乘的组合意义。

$\bold{Theorem\ 1.}$ 令 $a_n$ 为在一个长度为 $n$ 的区间上进行 A 操作的方案数，$b_n$ 为在一个长度为 $n$ 的区间上进行 B 操作的方案数。则其各自生成函数相乘得到的结果 $A(x)B(x) = C(x)$，其 $n$ 次项系数 $c_n$，表示将一个长度为 $n$ 的区间任意分隔成左右两个区间（可以为空区间），并在第一个区间上进行 A 操作，再在第二个区间上进行 B 操作的总方案数。

$\bold{Proof.}$ 考虑 $C(x)$ 的 $n$ 次项系数 $c_n = \sum_{i = 0}^n a_ib_{n - i}$，正相当于是枚举第一个区间的长度，然后用乘法原理将两个区间各自操作的方案数合并起来得到总方案数。

接下来让我们用几个例子加深对上述定理的理解。

$\bold{Example\ 4.}$ 一个学期有 $n$ 天，现需要将整个学期分割为上下两学期（可以为空，下同），且在上学期中选择一天为考试日，下学期中选择两天为考试日。求总方案数。

$\bold{Solution.}$ 根据 Theorem 1.，假设上学期有 $n$ 天，则选择考试日的方案数为 $\binom n 1$；假设下学期有 $n$ 天，则选择考试日的方案数为 $\binom n 2$。令两个序列的生成函数为 $A(x), B(x)$，有 $A(x) = \frac  x {(1 - x)^2}, B(x) = \frac {x^2}{(1 - x)^3}$。因此答案序列的生成函数 $C(x) = A(x)B(x) = \frac{x^3}{(1-x)^5} = x^3\sum_{n \geq 0}\binom{n + 4}{4}x^n  = \sum_{n \geq 3}\binom{n + 1}{4}x^n$。

因此 $[x^n]C(x) = c_n = \binom{n + 1}{4}$。

*笔记：考虑往生成函数的形式幂级数上乘上一个 $x$ 会发生什么，实际上就是整体将其左移了一位,这样就不难理解上例中的展开式了。*

$\bold{Example\ 5.}$ 仍然是将学期划分为上、下学期，但在划分之后，我们需要对上、下学期，选出任意天（不一定连续，下同）作为活动日。求方案数。

$\bold{Solution.}$ 对于半学期，方案数的生成函数为 $A(x) = \sum_{n \geq 0}2^nx^n = \frac{1}{1-2x}$；则对于整个学期，其方案数序列的生成函数为 $F(x) = A(x)^2$，即 $\frac 1 {(1-2x)^2}$。且我们发现 $F(x) = \frac 1 2 A'(x)$，则

*注：$A'(x)$ 表示 $A(x)$ 的导函数。*
$$
F(x) = \frac 1 2 \sum_{n \geq 1}n\cdot 2^n x^{n - 1} = \sum_{n \geq 0}(n + 1)2^nx^n
$$

则 $[x^n]f(x) = c_n = (n + 1)2^n$。

接下来的例子将展示生成函数的连乘的组合意义。

$\bold{Example\ 6.}$ 将一个学期划分为上、中、下学期。上学期选出任意天作为活动日；中学期选出奇数天作为活动日；下学期选出偶数天作为活动日。求方案数。

$\bold{Solution.}$ 上学期的方案数的生成函数为 $\frac 1 {1 - 2x}$，中学期的方案数的生成函数为 $\frac x {1 - 2x}$，下学期的方案数的生成函数为 $1 + \frac x {1 - 2x}$（因为啥都不选，即空集大小 $0$ 也是偶数）。

因此总方案数即为 $F(x) = A(x)B(x)C(x) = \frac{x(1-3x)}{(1-2x)^3}$。待定系数法得到

$$
F(x) = -\frac 1 4 \cdot\frac 1 {1 -2x} + \frac 1 4 \cdot \frac 1 {(1-2x)^3}
$$

最终可以得到

$$
F(x) = -\frac 1 4\sum_{n \geq 0}{2^nx^n} + \frac 1 4 \sum_{n \geq 0} \binom {n + 2}{2}2^n x^n
$$

则 $[x^n]F(x) = c_x = 2^{n - 3}(n^2 + 3n)$。


$\bold{Example\ 7.}$ 记在 $3$ 个绿色球、$3$ 个白色球、$3$ 个金色球中选择 $n$ 个球的方案数为 $a_n$。求 $a$ 的生成函数。

$\bold{Solution.}$ 相当于求方程 $e_1 + e_2 + e_3 = n, e_i \leq 3$ 的非负整数解的个数。可以转换为求对一个长度为 $n$ 的区间分隔成 $3$ 个子段，且每段长度不超过 $3$ 的方案数。根据 Theorem 1.，这个方案数就相当于三个部分内部的方案数生成函数的乘积。无论是什么颜色的球（第几段），在长度为 $k$ 时的方案数 $a_k = [k \leq 3]$。所以每一段内部的生成函数为 $(1 + x + x^2 + x^3)$，则答案的生成函数为 $(1 + x + x^2 + x^3)^3$。

$\bold{Example\ 8.}$ 与 Example 7. 类似，但现在多了 $5$ 个黑色球，且任意颜色的球至少出现一次，求选 $n$ 个球形成的序列的生成函数。

$\bold{Solution.}$ 仍然是转换为分隔区间的模型。相当于分隔成 $4$ 个子区间，且每个子区间长度至少为 $1$，前三个长度不超过 $3$，第四个长度不超过 $5$。则显然前三个区间的生成函数为 $(x + x^2 + x^3)$，最后一个的生成函数为 $(x + x^2 + x^3 + x^4 + x^5)$，则答案生成函数为 $(x + x^2 + x^3)^3(x + x^2 + x^3 + x^4 + x^5)$。

$\bold{Example\ 9.}$ 与 Example 8. 类似，但要求绿色、金色选择的个数必须为偶数，可以不选。

$\bold{Solution.}$ 思路仍然是表示出每个子段的生成函数并相乘，则答案为 $(x + x^2 + x^3)(1 + x^2)^2(x + x^2 + x^3+ x^4 + x^5)$。

$\bold{Example\ 10.}$ 求将 $n$ 个相同的球放入任意多个相同的盒子中，且每个盒子非空，且最多有 $k$ 个球的方案数。即 $p_{\leq k}(n)$。

$\bold{Solution.}$ 即问 $x_1 + 2_x2 + 3x_3\cdots kx_k = n$ 的正整数的方案数。

仍然转化为分隔区间的模型。但是这里要求第 $i$ 个区间，长度必须是 $i$ 的的倍数，那么第 $i$ 个区间的生成函数为 $\sum_{k \geq 0}x^{ki} = \frac 1 {1 - ix}$，则总的方案数为

$$
\prod_{i = 1}^k \frac 1 {1 - ix}
$$

### 1.3 生成函数的复合

$\bold{Definition\ 2}$ 令 $F(x), G(x)$ 分别为 $\{f_n\}, \{g_n\}$ 的生成函数，则定义 $F$ 复合 $G$ 为

$$
F(G(x)) = \sum_{n \geq 0}f_nG(x)^n
$$

需要特别说明的是，如果 $g_0 \neq 0$，则 $F(G(x))$ 的任意次项的系数都会是$无穷大^1$的。因此我们一般只对于 $g_0 = 0$ 的 $G(x)$ 研究复合。

*$注^1$：这里的描述不准确，询问译者并讨论后没有找到一个更好的描述，故维持不变，读者可以认为 $g_0 \neq 0 $ 时讨论无意义*

接下来我们考虑，将两个生成函数复合的组合意义。

$\bold{Theorem\ 2.}$ 令 $a_n$ 表示在一个长度为 $n$ 的区间上进行 $A$ 操作的方案数，其生成函数为 $A(x)$；$b_n$ 表示在一个长度为 $n$ 的区间上进行 $B$ 操作的方案数，其生成函数为 $B(x)$，则其生成函数的复合 $A(B(x)) = C(x)$ 的 $n$ 次项系数 $c_n$，表示将一个长度为 $n$ 的区间分隔成任意多个区间（每个区间必须连续，不能为空），并对每个区间进行操作 $B$，之后再将每一个区间看作一个元素（“缩起来”），得到一个新的区间（每个元素都是原来的一个区间），并对这个区间进行 $A$ 操作的方案数。

$\bold{Proof.}$ 考虑

$$
C(x) = \sum_{n \geq 0} a_nB(x)^n
$$

其中，$B(x)^n$ 代表将一个区间分隔为恰好 $n$ 段，每段进行 $B$ 操作的方案数。则其乘上 $a_n$ 就代表了在进行 B 操作之后，把分隔出的每段看成一个元素然后对新的区间进行 $A$ 操作的方案数。

接下来我们会通过几个例子加深对 $\bold{Theorem 2.}$ 的理解。

$\bold{Example \ 11.}$ $n$ 个士兵排成一排，现需要将这 $n$ 个士兵分隔为若干个班（每个班的士兵连续），且每个班至少一个人，并在每个班中选择一个士兵作为班长。求方案数。

$\bold{Solution.}$ 首先，对于一个 $n$ 人的班，其选择班长的方案数为 $n$，即 $B(x) = \sum_{n \geq 1}nx^n = \frac x {(1 - x)^2}$。其次，假设划分出了 $n$ 个班，本题中不需要对这 $n$ 个班进行什么操作，因此可以认为方案数为 $1$，则 $A(x) = \frac{1}{1 - x}$。那么根据 Theorem 2.，总方案数为

$$
C(x) = A(B(x)) = \frac{1}{1 - B(x)} = \frac{1}{1 - \frac{x}{(1 - x)^2}} = 1 + \frac x {1 - 3x + x^2}
$$

和 Example 3. 类似，我们设 $1 - 3x + x^2$ 的根为 $\alpha$ 和 $\beta$，那么 $\frac{1}{1-3x + x^2}$ 一定可以被表示为 $\frac A {x - \alpha} + \frac B {x - \beta}$，解方程得到 $A = B = \frac 1 {\sqrt 5}$，则 $C(x) = 1 + \frac x {\sqrt{5}}(\frac \alpha {1 - \alpha x} - \frac \beta {1 - \beta x})$，则 $c_n = \frac{1}{\sqrt{5}}(\alpha^n - \beta^n)$。

$\bold{Example\ 12.}$ 与 Example 11. 类似，不过在分隔班、指定班长之后，还需要选择一些班（不一定连续、可以为空）来出勤。求方案数。

$\bold{Solution.}$ 首先，对于一个 $n$ 人的班，其选择班长的方案数为 $n$，即 $B(x) = \sum_{n \geq 1}nx^n = \frac x {(1 - x)^2}$。其次，假设划分出了 $n$ 个班，那么有 $2^n$ 种选择出勤的方式。则其生成函数为 $A(x) = \frac {1}{1 - 2x}$。根据 Theorem 2.，总方案数为

$$
C(x) = A(B(x)) = \frac{1}{1- \frac{2x}{(1- x)^2}} = \frac{1 - x}{1 - 3x} = \frac{1}{1 - 3x} - \frac{x}{1 - 3x}
$$

所以

$$
C(x) = \sum_{n\geq 0}3^n x^n - \sum_{n \geq 1}3^{n - 1}x^n = 1 + \sum_{n \geq 1}(3 - 1)3^{n - 1}x^n
$$

因此有 $[x^n]C(x) = c_n = 2\cdot3^{n - 1}$。

## $\text{\S}$ 2. 指数生成函数

### $2.1$ 递推关系与指数生成函数

考察这样一个递推关系

$$
a_{n + 1} = (n + 1)(a_n - n + 1), a_0 = 1 \tag{6}
$$

$(6)$ 式用我们在 1.1 中介绍的方法去求解通项公式会稍显麻烦，因为这里我们不再是简单地给每个项乘上一个固定的系数然后相加了，这里会乘上 $n$，一个与下标有关的值。为此，我们引入指数生成函数来求解通项公式。

$\bold{Definition\ 3.}$ 令序列 $\{f_n\}_{n \geq 0}$ 为实数序列。则形式幂级数 $F(x) = \sum_{n \geq 0} f_n\frac{x^n}{n!}$ 为该序列的 **指数生成函数**（Expotional Generating Function, EGF）。且记 $f_n$ 为 $[x^n]G(x)$。

特别地 $f_i = 1$，则 $F(x)$ 恰为 $e^x$，这是为什么 $F(x)$ 被称为指数生成函数。

现在我们将展示如何用 EGF 来求 $(6)$ 的通项公式。

令 $G(x)$ 为 $\{a_n\}$ 的 EGF。

首先给等式两端乘上 $\frac{x^{n + 1}}{(n + 1)!}$，并求和，得到

$$
\sum_{n \geq 0} a_{n + 1}\frac{x^{n + 1}}{(n + 1)!} = \sum_{n \geq 0} a_n\frac{x^{n + 1}}{n!} - \sum_{n \geq 0}(n - 1)\frac {x^{n + 1}}{n!} 
$$

等式左边即为 $G(x) - 1$，右边第一项为 $xG(x)$，第二项拆开后为 $x^2e^x - xe^x$。因此我们有关于 $G(x)$ 的方程

$$
G(x) - 1 = xG(x) - x^2e^x + xe^x
$$

化简得到 $G(x) = \frac{1}{1 - x} + xe^x$，即

$$
G(x) = \sum_{n \geq 0}x^n + \sum_{n \geq 1}\frac{x^{n}}{(n - 1)!}
$$

考察 $[x^n]G(x) = n! + n$（注意右边第一项的系数是 $n!$ 不是 $1$，因为这里是对 EGF 进行运算，不是 OGF）。因此有答案。

上述过程告诉我们，EGF 与 GF 没有太多本质区别，使用 EGF 求解通项与 GF 类似，仍然是 1.1 中的 4 个步骤。


$\bold{Example\ 13.}$ 求递推关系 $f_0 = 0, f_{n + 1} = 2(n + 1)f_n + (n + 1)!$ 的通项公式。

$\bold{Solution.}$ 令 $F(x)$ 为 $\{f_n\}$ 的 EGF，有

$$
\sum_{n \geq 0} f_{n + 1}\frac{x^{n + 1}}{(n +1)!} = 2\sum_{n \geq 0}f_n\frac{x^{n + 1}}{n!} + \sum_{n \geq 0}x^{n + 1}
$$

化简成关于 $F(x)$ 的方程，我们有

$$
F(x)  = 2xF(x) + \frac x {1 - x}
$$

得到

$$
F(x) = \frac x {(1-x)(1-2x)} = \frac{1}{1-2x} - \frac{1}{1-x}
$$

所以 $[x^n]F(x) = f_n = n!(2^n - 1)$。

### 2.2 指数生成函数的乘法

在前面我们已经看到，普通生成函数的乘法与复合，都要求处理的对象是“连续的区间”，或者说这些对象都是相同的，不可区分的。指数生成函数与普通生成函数另一大区别，就在于指数生成函数处理的对象是“不连续的集合”，即这些对象是不同的，可区分的。

$\bold{Lemma\ 2.}$ $F(x), G(x)$ 分别为 $\{f_n\}, \{g_n\}$ 的指数生成函数。$A(x)$ 为序列 $\{c_n \mid c_n = \sum_{i = 0}^n \binom n i f_ig_{n - i}\}$ 则 $F(x)G(x) = A(x)$。

$\bold{Proof.}$ 

$$
\begin{aligned}
\sum_{n\geq 0}f_n\frac{x^n}{n!}\sum_{m\geq 0}g_m\frac{x^m}{m!} &= \sum_{n, m\geq 0}f_ng_m\frac{x^{n + m}}{n!m!}\\
&= \sum_{n, m \geq 0}\binom{n + m}n f_ng_m\frac{x^{n + m}}{(n + m)!}\\
& = \sum_{n \geq 0}\sum_{i = 0}^n \binom{n}{i} f_ig_{n - i}\frac{x^n}{n!}\\
& = \sum_{n \geq 0} c_n\frac{x^n}{n!}
\end{aligned}
$$

接下来我们考虑指数生成函数的组合意义。

$\bold{Theorem\ 3.}$ 令 $a_n$ 为在一个大小为 $n$ 的集合上进行 A 操作的方案数，$b_n$ 为在一个大小为 $n$ 的集合上进行 B 操作的方案数。则其各自生成函数相乘得到的结果 $A(x)B(x) = C(x)$，其 $n$ 次项系数 $c_n$，表示将一个大小为 $n$ 的集合任意划分成两个子集（可以为空集），并在第一个子集上进行 A 操作，再在第二个子集上进行 B 操作的总方案数。

$\bold{Proof.}$ 考虑 $C(x)$ 的 $n$ 次项系数 $c_n = \sum_{i = 0}^n \binom n i a_ib_{n - i}$，正相当于是枚举第一个子集的大小，然后用乘法原理将两个子集各自操作的方案数合并起来得到总方案数。

下面我们用几个例子来详细阐述 Theorem 3.。

$\bold{Example\ 14.}$ 一个足球队 $n$ 名球员，现在需要将 $n$ 名球员划分为两组（可以不连续），并每组各自任意排列。并且每个第一组的球员在排列后，需要选择红黄蓝三种球衣之一穿上。求总方案数。球员之间可以区分。

$\bold{Solution.}$  考虑第一组球员的指数生成函数，假设有 $n$ 个球员，那么排列的方案数为 $n!$，穿衣的方案数为 $3^n$，因此有 $F(x) = \sum_{n \geq 0}3^nn!3\frac{x^n}{n!} = \frac{1}{1 - 3x}$。

类似地，考虑第二组球员的指数生成函数 $G(x)$，显然为 $\frac{1}{1 - x}$。则根据 Theorem 3.，有

$$
A(x) = F(x)G(x) = \frac{1}{(1 - 3x)(1 - x)} = \frac{1}{2}(\frac{3}{1-3x} - \frac{1}{1 - x})
$$

因此 $[x^n]A(x) = n!(3^{n + 1} - 1)/2$。


### 2.3 指数生成函数的复合

$\bold{Definition\ 4.}$ 令 $F(x), G(x)$ 分别为 $\{f_n\}, \{g_n\}$ 的指数生成函数，且 $G(0) = 0$，则定义 $F$ 复合 $G$ 为

$$
F(G(x)) = 1 + \sum_{n \geq 1}f_n\frac{G(x)^n}{n!}
$$

接下来我们考虑，将两个指数生成函数复合的组合意义。

$\bold{Theorem\ 4.}$ 令 $a_n$ 表示在一个大小为 $n$ 的集合上进行A 操作的方案数，其指数生成函数为 $A(x)$；$b_n$ 表示在一个大小为 $n$ 的集合上进行 B 操作的方案数，其生成函数为 $B(x)$，则两者生成函数的复合 $A(B(x)) = C(x)$ 的 $n$ 次项系数 $c_n$，表示将一个大小为 $n$ 的集合划分任意多个子集（每个子集不一定连续，可以为空），并对每个子集进行操作 B，之后再将每一个子集看作一个元素（“缩起来”），得到一个新的集合（每个元素都是原来的一个子集），并对这个集合进行 A 操作的方案数。

$\bold{Proof.}$ 考虑

$$
C(x) = \sum_{n \geq 0} a_n\frac{B(x)^n}{n!}
$$

其中，$B(x)^n$ 代表将一个集合划分为恰好 $n$ 个子集，每个子集都进行 B 操作的方案数。则其乘上 $a_n$ 就代表了在进行 B 操作之后，把划分出的每个子集看成一个元素然后对新的区间进行 A 操作的方案数。

接下来我们会通过一个例子加深对 Theorem 4. 的理解。

$\bold{Example\ 15.}$ 一副 $n$ 张牌的牌，每张牌可以区分。我们需要将这 $n$ 张牌划分成任意个子牌堆（可以不连续），对于每个子牌堆，要求非空且有偶数张。对每个子牌堆内部的牌任意重排，再将这些子牌堆任意重排。求方案数，两个方案不同当且仅当存在一张牌，所属子牌堆的编号在两个方案中不同，或在所属子牌堆中，其下标在两个方案中不同。

$\bold{Solution}.$ 对于一个大小为 $n$ 的子牌堆，若 $n > 0, 2 | n$，则其方案数 $b_n = n!$，否则为 $0$。容易得到 $b_n$ 的指数生成函数 $B_n = \sum_{n > 0, 2 | n}n! \frac{x^n}{n!} = \frac{x^2}{1-2x}$。

类似地，对于一个有 $n$ 个子牌堆的划分方案，其重排方案为 $n!$，其指数生成函数为 $\frac{1}{1 - x}$。

根据 Theorem 4.，有总方案数

$$
C(x) = A(B(x)) = \frac{1}{1 - \frac{x^2}{1 - 2x}} = \frac{1 - x^2}{1 - 2x^2}\\= 1 + \frac{x^2}{1 - 2x^2} = 1 + \sum_{n \geq 0} 2^nx^{2n + 2}
$$

则

$$
[x^n]C(x) = \begin{cases}
0 & n\text{ is odd} \\
n!2^{\frac{n}{2} - 1} & \text{otherwise}
\end{cases}
$$